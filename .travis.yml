language: python

python:
  - "3.5"
  - "3.6"

install: pip install tox-travis
script: tox

jobs:
  include:
    - stage: package
      install:
      script:
      - # install Miniconda, a mostly static build of Python, into AppDir
      - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
      - bash Miniconda3-latest-Linux-x86_64.sh -b -p pext.AppDir/usr -f
      - # activate Miniconda environment
      - . pext.AppDir/usr/bin/activate
      - # install dependencies
      - conda install -y -c anaconda pyopengl
      - conda install -c conda-forge pygit2
      - pip install PyQt5==5.8
      - # install Pext
      - python setup.py install
      - # set up Desktop file and icon
      - cp pext.desktop pext.AppDir
      - cp pext/images/scalable/pext.svg pext.AppDir
      - # patch Desktop file to make sure Pext is executed correctly
      - # beware that AppRun chdir()s into usr/ inside the AppImage, that's why one has to remove that from pext's relative path
      - sed -i 's|Exec=.*|Exec=python bin/pext|' pext.AppDir/pext.desktop
      - # install AppRun into AppDir
      - wget https://github.com/AppImage/AppImageKit/releases/download/continuous/AppRun-x86_64 -O pext.AppDir/AppRun
      - chmod +x pext.AppDir/AppRun
      - # build AppImage
      - wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
      - chmod +x appimagetool-x86_64.AppImage
      - ./appimagetool-x86_64.AppImage pext.AppDir pext-x86_64.AppImage
      - # upload AppImage to transfer.sh (temporary, shall be replaced by uploadtool eventually)
      - curl --upload-file pext-x86_64.AppImage https://transfer.sh/pext-x86_64.AppImage

stages:
  - test
  - package
